<?xml version="1.0"?>
<robot xmlns:xacro="http://wiki.ros.org/xacro" name="ur10e_robotiq">

  <!-- ============================================ -->
  <!-- Parameters -->
  <!-- ============================================ -->
  <xacro:arg name="name" default="ur10e"/>
  <xacro:arg name="ur_type" default="ur10e"/>
  <xacro:arg name="tf_prefix" default=""/>
  <xacro:arg name="safety_limits" default="false"/>
  <xacro:arg name="safety_pos_margin" default="0.15"/>
  <xacro:arg name="safety_k_position" default="20"/>

  <!-- File path parameters -->
  <xacro:arg name="joint_limit_params" default="$(find ur_description)/config/$(arg ur_type)/joint_limits.yaml"/>
  <xacro:arg name="kinematics_params" default="$(find ur_description)/config/$(arg ur_type)/default_kinematics.yaml"/>
  <xacro:arg name="physical_params" default="$(find ur_description)/config/$(arg ur_type)/physical_parameters.yaml"/>
  <xacro:arg name="visual_params" default="$(find ur_description)/config/$(arg ur_type)/visual_parameters.yaml"/>

  <!-- ros2_control related parameters -->
  <xacro:arg name="headless_mode" default="false" />
  <xacro:arg name="robot_ip" default="0.0.0.0" />
  <xacro:arg name="script_filename" default=""/>
  <xacro:arg name="output_recipe_filename" default=""/>
  <xacro:arg name="input_recipe_filename" default=""/>
  <xacro:arg name="reverse_ip" default="0.0.0.0"/>
  <xacro:arg name="script_command_port" default="50004"/>
  <xacro:arg name="reverse_port" default="50001"/>
  <xacro:arg name="script_sender_port" default="50002"/>
  <xacro:arg name="trajectory_port" default="50003"/>

  <!-- Tool communication related parameters -->
  <xacro:arg name="use_tool_communication" default="false" />
  <xacro:arg name="tool_voltage" default="0" />
  <xacro:arg name="tool_parity" default="0" />
  <xacro:arg name="tool_baud_rate" default="115200" />
  <xacro:arg name="tool_stop_bits" default="1" />
  <xacro:arg name="tool_rx_idle_chars" default="1.5" />
  <xacro:arg name="tool_tx_idle_chars" default="3.5" />
  <xacro:arg name="tool_device_name" default="/tmp/ttyUR" />
  <xacro:arg name="tool_tcp_port" default="54321" />

  <!-- Simulation parameters -->
  <xacro:arg name="use_mock_hardware" default="false" />
  <xacro:arg name="mock_sensor_commands" default="false" />
  <xacro:arg name="initial_positions_file" default="$(find ur_description)/config/initial_positions.yaml"/>

  <!-- Convert to property for substitution -->
  <xacro:property name="initial_positions_file" default="$(arg initial_positions_file)"/>

  <!-- Gripper parameters -->
  <xacro:arg name="use_fake_gripper_hardware" default="false"/>
  <xacro:arg name="gripper_com_port" default="/tmp/ttyUR"/>

  <!-- ============================================ -->
  <!-- Import UR macro -->
  <!-- ============================================ -->
  <xacro:include filename="$(find ur_description)/urdf/ur_macro.xacro"/>

  <!-- ros2_control include -->
  <xacro:include filename="$(find ur_robot_driver)/urdf/ur.ros2_control.xacro" />

  <!-- ============================================ -->
  <!-- Import Robotiq gripper macro -->
  <!-- ============================================ -->
  <xacro:include filename="$(find robotiq_description)/urdf/robotiq_2f_85_macro.urdf.xacro"/>

  <!-- ============================================ -->
  <!-- World link (required for robot_state_publisher) -->
  <!-- ============================================ -->
  <link name="world"/>

  <!-- ============================================ -->
  <!-- Instantiate UR10e -->
  <!-- ============================================ -->
  <xacro:ur_robot
    name="$(arg name)"
    tf_prefix="$(arg tf_prefix)"
    parent="world"
    joint_limits_parameters_file="$(arg joint_limit_params)"
    kinematics_parameters_file="$(arg kinematics_params)"
    physical_parameters_file="$(arg physical_params)"
    visual_parameters_file="$(arg visual_params)"
    safety_limits="$(arg safety_limits)"
    safety_pos_margin="$(arg safety_pos_margin)"
    safety_k_position="$(arg safety_k_position)"
    >
    <origin xyz="0 0 0" rpy="0 0 0" />
  </xacro:ur_robot>

  <!-- ============================================ -->
  <!-- ros2_control instance for UR -->
  <!-- ============================================ -->
  <xacro:ur_ros2_control
    name="$(arg name)"
    tf_prefix="$(arg tf_prefix)"
    kinematics_parameters_file="$(arg kinematics_params)"
    use_mock_hardware="$(arg use_mock_hardware)"
    mock_sensor_commands="$(arg mock_sensor_commands)"
    headless_mode="$(arg headless_mode)"
    initial_positions="${xacro.load_yaml(initial_positions_file)}"
    use_tool_communication="$(arg use_tool_communication)"
    tool_voltage="$(arg tool_voltage)"
    tool_parity="$(arg tool_parity)"
    tool_baud_rate="$(arg tool_baud_rate)"
    tool_stop_bits="$(arg tool_stop_bits)"
    tool_rx_idle_chars="$(arg tool_rx_idle_chars)"
    tool_tx_idle_chars="$(arg tool_tx_idle_chars)"
    tool_device_name="$(arg tool_device_name)"
    tool_tcp_port="$(arg tool_tcp_port)"
    robot_ip="$(arg robot_ip)"
    script_filename="$(arg script_filename)"
    output_recipe_filename="$(arg output_recipe_filename)"
    input_recipe_filename="$(arg input_recipe_filename)"
    reverse_ip="$(arg reverse_ip)"
    script_command_port="$(arg script_command_port)"
    reverse_port="$(arg reverse_port)"
    script_sender_port="$(arg script_sender_port)"
    trajectory_port="$(arg trajectory_port)"
  />

  <!-- ============================================ -->
  <!-- Attach Robotiq 2F-85 to UR tool0 -->
  <!-- ============================================ -->
  <xacro:robotiq_gripper
    name="RobotiqGripperHardwareInterface"
    prefix=""
    parent="tool0"
    use_fake_hardware="$(arg use_fake_gripper_hardware)"
    com_port="$(arg gripper_com_port)"
    >
    <!-- Adjust this transform based on your actual mounting -->
    <!-- Default: gripper aligned with tool0 flange -->
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:robotiq_gripper>

  <!-- ============================================ -->
  <!-- Tool Center Point (TCP) at gripper tip -->
  <!-- ============================================ -->
  <!-- Define TCP at the center point between finger tips -->
  <!-- Robotiq 2F-85: ~165mm from base to fingertips when open -->
  <link name="tool_tcp">
    <!-- Virtual link, no physical properties needed -->
  </link>

  <joint name="tool_tcp_joint" type="fixed">
    <parent link="robotiq_85_base_link"/>
    <child link="tool_tcp"/>
    <!-- TCP from robot teach pendant calibration -->
    <!-- Position: X=-11.01mm, Y=-1.3mm, Z=232.63mm -->
    <!-- Rotation: RX=0.0094rad, RY=0.0022rad, RZ=0.0397rad -->
    <origin xyz="-0.01101 -0.0013 0.23263" rpy="0.0094 0.0022 0.0397"/>
  </joint>

</robot>
